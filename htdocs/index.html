<!doctype html>
<html lang="de">
   <head>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
      <!-- Bootstrap CSS -->
      <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
      <link rel="stylesheet" href="style.css?v=2122132342" />
      <link rel="stylesheet" href="style2.css?ver=122212343221" />
      <title>Hello, world!</title>
   </head>
   <body>

     <!-- LOGIN DIALOG BOX -->
     <div class="modal fade" id="whiteboardlogon" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
           <div class="modal-content">
              <div class="modal-header">
                 <h5 class="modal-title text-dark" id="exampleModalLongTitle">Verinde dich zum Whiteboard!</h5>
              </div>
              <div class="modal-body">
                 <form>
                    <div class="alert alert-danger" role="alert">
                       Das Tool befindet sich noch in der Entwicklungsphase.
                    </div>
                    <div class="form-group">
                       <div class="input-group">
                          <div class="input-group-prepend">
                             <label class="input-group-text" for="validatedInputGroupSelect">Whiteboard</label>
                          </div>
                          <input type="text" class="form-control" id="WhiteboardNameInput" aria-describedby="WhiteboardNameHelp" placeholder="Whiteboard Name eingeben" />
                       </div>
                    </div>
                    <div class="form-group">
                       <div class="input-group">
                          <div class="input-group-prepend">
                             <label class="input-group-text" for="validatedInputGroupSelect">Name</label>
                          </div>
                          <input type="text" class="form-control" id="UserNameInput" aria-describedby="UserNameHelp" placeholder="Wähle einen Benutzer" />
                       </div>
                    </div>
                 </form>
              </div>
              <div class="modal-footer">
                 <button type="button" class="btn btn-primary" id="ConnectToWhiteboard">Verbinden</button>
              </div>
           </div>
        </div>
     </div>

     <div class="wrapper">

       <div id="sidebar" class="active">
         <div class="sidebar-header">
           <h4 id="idview"></h4>
         </div>

         <div class="sidebar-content">

           <div class="sidebar-row">
             <div class="form-group">
               <h3>Notizblock</h3>
               <textarea class="form-control" id="Scratchpad" rows="3" placeholder="Der Notizblock ist nur für dich. Niemand kann sehen was du hier schreibst."></textarea>
             </div>
           </div>

           <div class="sidebar-row sidebarcolor2">
             <div class="form-group">
               <h3>Chat</h3>
               <div id="chatprotocol" class="p-2">
               </div><br/>
               <input type="text" class="form-control" id="chatinput" placeholder="Schreibe eine Nachricht">
             </div>
           </div>

         </div>

       </div>

      <div id="content">
        <h1 contenteditable="true">Click here to change title!</h1>


        <button type="button" class="btn btn-info" id="sidebarCollapse">
          <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-layout-sidebar-inset" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M14 2H2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1zM2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2z"></path>
            <path d="M3 4a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V4z"></path>
          </svg>
        </button>

        <button type="button" class="btn btn-info" id="newStickyNote">
          <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-sticky" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <path fill-rule="evenodd" d="M1 2.5A1.5 1.5 0 0 1 2.5 1h11A1.5 1.5 0 0 1 15 2.5v6.086a1.5 1.5 0 0 1-.44 1.06l-4.914 4.915a1.5 1.5 0 0 1-1.06.439H2.5A1.5 1.5 0 0 1 1 13.5v-11zM2.5 2a.5.5 0 0 0-.5.5v11a.5.5 0 0 0 .5.5h6.086a.5.5 0 0 0 .353-.146l4.915-4.915A.5.5 0 0 0 14 8.586V2.5a.5.5 0 0 0-.5-.5h-11z"/>
            <path fill-rule="evenodd" d="M9.5 9a.5.5 0 0 0-.5.5v5H8v-5A1.5 1.5 0 0 1 9.5 8h5v1h-5z"/>
          </svg>
        </button>

        <div id="myForm" class="d-none">
            <form action="/echo/html/" id="popForm" method="get">
                <div>


<label>
  <input type="radio" name="color" value="paleblue">
  <img src="paleblue.svg" />
</label>

<label>
  <input type="radio" name="color" value="canary" checked>
  <img src="canary.svg" />
</label>

<label>
  <input type="radio" name="color" value="limegreen">
  <img src="limegreen.svg" />
</label>

<label>
  <input type="radio" name="color" value="paleorange">
  <img src="paleorange.svg" />
</label>

<label>
  <input type="radio" name="color" value="palepink">
  <img src="palepink.svg" />
</label>

<label>
  <input type="radio" name="color" value="bananayellow">
  <img src="bananayellow.svg" />
</label>
<br/>
<!--           <label class="radio-inline">
              <input type="radio" name="color" value="canary" checked>Canary
            </label>
            <label class="radio-inline">
              <input type="radio" name="color" value="limegreen">Limegreen
            </label>
            <label class="radio-inline">
              <input type="radio" name="color" value="paleblue">paleblue
            </label>
    -->


                    <label for="content">Inhalt:</label>
                    <textarea rows="3" name="content" id="content" class="form-control input-md"></textarea>
                    <button type="button" class="btn btn-primary" data-loading-text="Sending info.."><em class="icon-ok"></em>erstellen</button>
                </div>
            </form>
        </div>





        <ul id="stickyboard">

        </ul>

      </div>
     </div>



      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
      <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
      <script src="jquery.textfill.min.js"></script>
      <script>

           var Socket;

      var WhiteboardTitle = $("h1").text();

      function isEmptyOrSpaces(str){
          return str === null || str.match(/^ *$/) !== null;
      }

      function uuidv4() {
        return ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
          (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
        );
      }



      function processReceivedMessage(msg)
      {
        	if ( msg.type === 'AddStickyNote' )
        	{
            let li = $('<li/>',{ 'id':msg.uuid}).appendTo('#stickyboard');

            let a = $('<a/>',{ 'href': '#',
                               'id': 'link_' + msg.uuid,
                               'class': 'sticky_color_' + msg.color,
                               'mouseenter': function(){ $('#' + msg.uuid + ' .notebar').removeClass('d-none'); },
                               'mouseleave': function(){ $('#' + msg.uuid + ' .notebar').addClass('d-none'); }
                             }).appendTo(li);

            let span = $('<span/>',{ 'html': msg.content}).appendTo(a);

            let spanuser = $('<span/>',{ 'class': "badge noteuser badge-info",
                                         'text': msg.user }).appendTo(a);

            let spannotebar = $('<span/>',{ 'class': "notebar d-none"}).appendTo(a);

            let spanbutton = $('<span/>',{ 'class': "badge notebutton badge-danger",
                                         'html': '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-trash" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>',
                                          'click': function(){ Socket.send('{  "type" : "DeleteStickyNote",  "uuid" : "' + msg.uuid +  '" }') } }).appendTo(spannotebar);

            let upvotebutton = $('<span/>',{ 'class': "badge notebutton badge-success",
                                 'html': '<svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-hand-thumbs-up" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M6.956 1.745C7.021.81 7.908.087 8.864.325l.261.066c.463.116.874.456 1.012.965.22.816.533 2.511.062 4.51a9.84 9.84 0 0 1 .443-.051c.713-.065 1.669-.072 2.516.21.518.173.994.681 1.2 1.273.184.532.16 1.162-.234 1.733.058.119.103.242.138.363.077.27.113.567.113.856 0 .289-.036.586-.113.856-.039.135-.09.273-.16.404.169.387.107.819-.003 1.148a3.163 3.163 0 0 1-.488.901c.054.152.076.312.076.465 0 .305-.089.625-.253.912C13.1 15.522 12.437 16 11.5 16v-1c.563 0 .901-.272 1.066-.56a.865.865 0 0 0 .121-.416c0-.12-.035-.165-.04-.17l-.354-.354.353-.354c.202-.201.407-.511.505-.804.104-.312.043-.441-.005-.488l-.353-.354.353-.354c.043-.042.105-.14.154-.315.048-.167.075-.37.075-.581 0-.211-.027-.414-.075-.581-.05-.174-.111-.273-.154-.315L12.793 9l.353-.354c.353-.352.373-.713.267-1.02-.122-.35-.396-.593-.571-.652-.653-.217-1.447-.224-2.11-.164a8.907 8.907 0 0 0-1.094.171l-.014.003-.003.001a.5.5 0 0 1-.595-.643 8.34 8.34 0 0 0 .145-4.726c-.03-.111-.128-.215-.288-.255l-.262-.065c-.306-.077-.642.156-.667.518-.075 1.082-.239 2.15-.482 2.85-.174.502-.603 1.268-1.238 1.977-.637.712-1.519 1.41-2.614 1.708-.394.108-.62.396-.62.65v4.002c0 .26.22.515.553.55 1.293.137 1.936.53 2.491.868l.04.025c.27.164.495.296.776.393.277.095.63.163 1.14.163h3.5v1H8c-.605 0-1.07-.081-1.466-.218a4.82 4.82 0 0 1-.97-.484l-.048-.03c-.504-.307-.999-.609-2.068-.722C2.682 14.464 2 13.846 2 13V9c0-.85.685-1.432 1.357-1.615.849-.232 1.574-.787 2.132-1.41.56-.627.914-1.28 1.039-1.639.199-.575.356-1.539.428-2.59z"/></svg>',
                                                                        'click': function(){ Socket.send('{  "type" : "UpvoteStickyNote",  "uuid" : "' + msg.uuid +  '" }') } }).appendTo(spannotebar);

            $('#link_' + msg.uuid).textfill({ maxFontPixels: 150 });
        	}

        	if ( msg.type === 'DeleteStickyNote' )
        	{
        		$( "#" + msg.uuid ).remove( );
        	}

          if ( msg.type === 'WhiteboardTitle')
          {
            if ( WhiteboardTitle !== msg.WhiteboardTitle )
            {
              WhiteboardTitle = msg.WhiteboardTitle;
              $("h1").text(WhiteboardTitle);
            }
          }

        	if ( msg.type === 'UpvoteStickyNote' )
        	{
        		let counter = $( '#like_counter_' + msg.uuid );

        		if ( counter.length )
        		{
        			console.log("incrementing counter");
        			$( '#like_counter_' + msg.uuid ).text( parseInt(counter.text(),10) + 1 );
        		}
        		else
        		{
        			console.log("creating new badge");
        			$('<span class="badge badge-success notevote" id="like_counter_' + msg.uuid + '">1</span>').appendTo('#link_' + msg.uuid);
        		}
        	}

          if ( msg.type === 'ChatMessage' )
          {
            let chatcontent = msg.content;


            $('<p class="chatmessage"><b>' + msg.user + ': </b> ' + chatcontent + '</p>').appendTo('#chatprotocol');
            var d = $('#chatprotocol');
            d.scrollTop(d.prop("scrollHeight"));

          }
      }



         $(document).ready(function()
         {



           $('#sidebarCollapse').on('click', function () {
               $('#sidebar').toggleClass('active');
           });


           $('#whiteboardlogon').modal({backdrop: 'static', keyboard: false});

           $('#ConnectToWhiteboard').click( function() {

              let connectionURL = "ws://localhost:8181/" + $("#WhiteboardNameInput").val();
              console.log("Try to connect to: " + connectionURL);

              Socket =  new WebSocket(connectionURL, "protocolOne");

              Socket.onopen  = function (event) {
                console.log("Connected to Server");

                $('#whiteboardlogon').modal('hide');

                $('#idview').text($("#UserNameInput").val() + "@" + $("#WhiteboardNameInput").val());

                Socket.send('{"type":"User","name":"' + $("#UserNameInput").val() + '"}');
                Socket.send('{"type":"GetHistory"}');
              }

              Socket.onmessage = function (event) {
                console.log("A new Message was received:");
                console.log(event.data);

                let msg = JSON.parse(event.data);

                if ( typeof msg.type !== 'undefined' )
                {
                  if ( msg.type === 'History' )
                  {
                    msg.history.forEach( currentmsg => processReceivedMessage(currentmsg) );
                  }
                  else
                  {
                    processReceivedMessage(msg);
                  }
                }
              }


              $("h1").focusout( function() {
                if ( $("h1").text() !== WhiteboardTitle )
                {
                  let NewWhiteboardTitle = $("h1").text();

                  console.log(NewWhiteboardTitle);

                  Socket.send('{"type":"WhiteboardTitle","WhiteboardTitle":"' + NewWhiteboardTitle + '"}');

                  WhiteboardTitle = NewWhiteboardTitle;
                }

              });

              $('#chatinput').keypress(function(event){
        var keycode = (event.keyCode ? event.keyCode : event.which);
        if(keycode == '13')
        {
          let content = $('#chatinput').val();

          if ( !isEmptyOrSpaces(content) )
          {
            let ChatMessage = {
              type: "ChatMessage",
              content: content
            };

            Socket.send(JSON.stringify(ChatMessage));

             $('#chatinput').val("");
          }
        }
    });


    $(function(){
        $('#newStickyNote').popover({
        	sanitize: false,
            placement: 'bottom',
      //      title: 'Popover Form',
            html:true,
            content:  $('#myForm').html()
        }).on('click', function(){
          // had to put it within the on click action so it grabs the correct info on submit
          $('.btn-primary').click(function(){

          	let title = $(".popover #title").val();
          	let content = $(".popover #content").val();

    	      let color = document.querySelector('.popover input[name="color"]:checked').value;

           if (!(isEmptyOrSpaces( content ) ))
           {
              let AddStickyNoteMessage = {
                type: "AddStickyNote",
                uuid: uuidv4(),
                content: content,
                color: color };

              Socket.send(JSON.stringify(AddStickyNoteMessage));
            }

              $('.popover').popover('hide');

          })
      })
    });









           });



         });



      </script>
   </body>
</html>
